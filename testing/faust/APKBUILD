# Contributor: Francesco Camuffo <dev@fmac.xyz>
# Maintainer: Francesco Camuffo <dev@fmac.xyz>
pkgname=faust
pkgver=2.37.3
pkgrel=0
pkgdesc="Functional programming language for realtime audio signal processing"
url="https://faust.grame.fr"
arch="all"
license="GPL-2.0-or-later"
checkdepends="bash"
makedepends="
	cmake
	libexecinfo-dev
	libmicrohttpd-dev
	libsndfile-dev
	llvm-dev
	"
subpackages="$pkgname-doc $pkgname-dev"
source="$pkgname-$pkgver.tar.gz::https://github.com/grame-cncm/faust/releases/download/$pkgver/faust-$pkgver.tar.gz
	faust-musl-stacktrace.patch
	faust-tests-old-libraries.patch"

build() {
	cmake -B "$pkgname"-build \
		-S build \
		-C build/backends/all.cmake \
		-C build/targets/all.cmake \
		-DCMAKE_BUILD_TYPE=None \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DINCLUDE_DYNAMIC=ON \
		-DINCLUDE_STATIC=ON \
		-DINCLUDE_ITP=ON \
		-Wno-dev
	make VERBOSE=1 -C "$pkgname"-build
	make VERBOSE=1 -C tools/sound2faust
}

check() {
	make interp -C tests/compile-tests
}

package() {
	make -C "$pkgname"-build PREFIX=/usr DESTDIR="$pkgdir" install

	# remove precompiled shared libraries for android:
	# https://github.com/grame-cncm/faust/issues/370
	rm -rvf "$pkgdir"/usr/share/faust/android/app/lib \
		"$pkgdir"/usr/share/faust/android/app/oboe \
		"$pkgdir"/usr/share/faust/smartKeyboard/android/app/oboe

	# rename usage.sh to something more appropriate
	mv "$pkgdir"/usr/bin/usage.sh "$pkgdir"/usr/bin/faust-usage.sh
}

sha512sums="
29c27c1d4b71f63e5a42abdb1557e88ac9d623242a85df16478756a7bcbc3fe78466ace1280ea6a3cd04c979201e52a703f7be53b8a047dcc1f8fa7e034ef26d  faust-2.37.3.tar.gz
f3e07bdd26ab8f0ffbf0c0dfbf8141facc07d2db05346f3b982faca613aa5ecad8986683db8d49caed720d58b183b215d6e1c4ceef069f29f41bcfa699ad5f28  faust-musl-stacktrace.patch
fe0b800809ea1fcb4fd44e306eff7f01b9316ddc3406bdc52f0e783a3710b5b8e6e05a5925766e4fd73666cc6ca9f42027f608c7f7dbe44436b28e1787703595  faust-tests-old-libraries.patch
"
